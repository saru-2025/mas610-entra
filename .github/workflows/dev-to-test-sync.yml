- name: ðŸš€ Sync and Push updates to Test repo
        env:
          TEST_REPO_URL: https://saru-2025:${{ secrets.GIT_TEST_TOKEN }}@github.com/saru-2025/mas610-entra-test.git
        
        run: |
          echo "Cloning Test repo history..."
          
          # Use the fully robust strategy: Clone the Git history only.
          # We use "set +e" (turn off immediate exit on error) just for the clone 
          # to ensure code 24 does not fail the step.
          set +e
          git clone --no-checkout --depth 1 $TEST_REPO_URL test-repo
          CLONE_EXIT_CODE=$?
          set -e # Re-enable immediate exit on error
          
          # Check if the clone failed with an unexpected code (e.g., 128 for auth)
          if [ $CLONE_EXIT_CODE -ne 0 ] && [ $CLONE_EXIT_CODE -ne 24 ]; then
            echo "Error: Git clone failed with UNEXPECTED exit code $CLONE_EXIT_CODE."
            exit 1
          fi

          echo "âœ… Git clone completed (warning/code 24 ignored)."

          # Change directory to the newly cloned test-repo
          cd test-repo
          git checkout main
          cd .. # Move back to the root directory

          echo "Running rsync to copy Dev contents over Test repo..."
          rsync -av --delete --exclude='.git' ./ test-repo/

          # 4. Commit and Push the changes from the Test repo directory
          cd test-repo
          git add .
          git commit -m "ðŸš€ Auto-sync Dev â†’ Test - $GITHUB_SHA" || echo "âœ… No new changes to commit"
          git push origin main
          
          echo "ðŸŽ‰ Sync completed successfully!"
